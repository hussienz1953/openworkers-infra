volumes:
  postgres_data:

services:
  # Postgres
  postgres:
    image: postgres:15.1-alpine3.17
    volumes:
      - postgres_data:/var/lib/postgresql/data:rw
    env_file:
      - .env
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready --quiet --username=$POSTGRES_USER --dbname=$POSTGRES_DB",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
  # NATS
  nats:
    image: nats:2.12.2-alpine3.22
    healthcheck:
      test: ["CMD-SHELL", "wget http://localhost:8222/healthz -q -S -O -"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
  # OpenWorkers API
  openworkers-api:
    image: ghcr.io/openworkers/openworkers-api:v1.2.1
    depends_on:
      - postgate
    env_file:
      - .env
    environment:
      - NODE_ENV=production
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:7000/api/health || exit 1",
        ]
      interval: 60s
      timeout: 5s
      retries: 5
      start_period: 10s
  # Postgate (HTTP proxy for Postgres)
  # Uses OpenWorkers database via views (postgate_databases, postgate_tokens)
  postgate:
    image: ghcr.io/openworkers/postgate:v0.1.2
    environment:
      - DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres/${POSTGRES_DB}
      - RUST_LOG=postgate=info
      - POSTGATE_HOST=0.0.0.0
      - POSTGATE_PORT=6080
      - POSTGATE_SKIP_MIGRATIONS=true
    depends_on:
      - postgres
  # OpenWorkers Proxy
  openworkers-proxy:
    image: nginx:1.25.1-alpine-slim
    depends_on:
      - openworkers-runner
      - openworkers-api
    volumes:
      - ${HTTP_TLS_CERTIFICATE}:/certs/ssl.crt:ro
      - ${HTTP_TLS_KEY}:/certs/ssl.key:ro
      - ./nginx:/etc/nginx:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://127.0.0.1/health || exit 1",
        ]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
  # OpenWorkers Runner
  openworkers-runner:
    image: ghcr.io/openworkers/openworkers-runner:v0.7.5-v8
    env_file:
      - .env
    environment:
      - RUST_LOG=openworkers_runtime=debug,openworkers_runner=debug
    depends_on:
      - postgres
      - nats
    deploy:
      replicas: 3
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://127.0.0.1:8080/health || exit 1",
        ]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
  # OpenWorkers Logs Service
  openworkers-logs:
    image: ghcr.io/openworkers/openworkers-logs:v0.1.4
    env_file:
      - .env
    environment:
      - RUST_LOG=openworkers_logs=info
    depends_on:
      - postgres
      - nats
  # OpenWorkers Scheduler Service
  openworkers-scheduler:
    image: ghcr.io/openworkers/openworkers-scheduler:v0.1.3
    env_file:
      - .env
    environment:
      - RUST_LOG=openworkers_scheduler=info
    depends_on:
      - postgres
      - nats

  # OpenWorkers Dashboard
  openworkers-dash:
    image: ghcr.io/openworkers/openworkers-dash:v1.2.1
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://127.0.0.1:80/ || exit 1",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
